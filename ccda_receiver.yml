- include: tasks/node_mongo_tasks.yml

- name: Firewall | Allow web ports
  tags: firewall
  action: command ufw allow $item 
  with_items: ["80", "3000", "3001"]


- name: CCDA-R | Install packages
  tags: ccda-receiver
  action: apt pkg=$item state=installed
  with_items:
    - libxml2-dev
    - python-software-properties
    - g++
    - make

- name: CCDA-R | git clone
  tags: ccda-receiver
  action: git repo=https://github.com/chb/ccdaReceiver
              dest=/opt/ccda-receiver
              version=HEAD

- name: CCDA-R | npm install dependencies
  tags: ccda-receiver
  action: command npm install
          chdir=/opt/ccda-receiver

- name: CCDA-R | copy rxnorm concepts
  tags: ccda-receiver-mongo
  action: copy 
          src=files/rxnorm-mongo.tgz
          dest=/tmp/install/rxnorm-mongo.tgz
          owner=root group=root mode=0644

- name: CCDA-R | extract rxnorm concepts
  tags: ccda-receiver-mongo
  action: command tar -xzvf rxnorm-mongo.tgz
          chdir=/tmp/install

- name: CCDA-R | restore rxnorm concepts
  tags: ccda-receiver-mongo
  action: command mongorestore /tmp/install/dump/rxnorm --drop


- name: CCDA-R | startup scripts
  tags: ccda-receiver
  action: template 
          src=templates/ccda_receiver/upstart/${item}.j2
          dest=/etc/init/$item
          owner=root group=root mode=0644
  with_items:
    - ccda-receiver.conf
    - ccda-receiver-apps.conf

- name: Debug ccdar params
  tags: ccda-receiver
  action: debug msg="CCDA REceiver url ${ccda_receiver_url}"

- name: CCDA-R | install default apps script - run
  tags: ccda-receiver
  action: command node tasks/bootstrap.js chdir=/opt/ccda-receiver
  environment:
    PUBLIC_URI: $ccda_receiver_url
    APP_SERVER: $ccda_receiver_apps_url

- name: CCDA-R | run servers
  tags: ccda-receiver
  action: service name=$item state=restarted
  with_items: 
    - ccda-receiver
    - ccda-receiver-apps

- name: CCDA-R | create sample data dir
  tags: ccda-receiver
  action: file path=/tmp/install/sample_ccdas/ state=directory

- name: CCDA-R | copy sample patient data
  tags: ccda-receiver
  action: copy src=$item dest=/tmp/install/sample_ccdas/
  with_fileglob: files/sample_ccdas/*.xml

- name: CCDA-R | list sample files
  tags: ccda-receiver
  action: split_sample_filename name=$item
  with_fileglob: files/sample_ccdas/*.xml
  register: to_post

- name: CCDA-R | install sample patients
  tags: ccda-receiver
  action: command curl -X POST -d @${item.file} http://127.0.0.1:3000/internal/addPatient/${item.pid}
          chdir=/tmp/install/sample_ccdas
  with_items:  ${to_post.results}

- name: nginx | config file
  tags: nginx
  action: template 
          src=templates/ccda_receiver/nginx/ccda-receiver-site.j2
          dest=/etc/nginx/sites-enabled/ccda-receiver-site
          owner=root group=root mode=0644

- name: nginx | start service
  tags: nginx
  action: service name=nginx state=restarted
